ARG CI_REGISTRY_IMAGE
ARG BUILDER_TAG
ARG NODE_VERSION
FROM ${CI_REGISTRY_IMAGE}:${BUILDER_TAG}_${TARGETARCH}_min_artifacts AS builder
FROM node:${NODE_VERSION}-alpine
LABEL maintainer="Karsten Hassel"

USER root

ENV MM_DIR=/opt/magic_mirror
WORKDIR $MM_DIR

COPY --from=builder --chmod=0777 --chown=node:node $MM_DIR $MM_DIR
# copy startscripts into container:
COPY --chmod=0777 --chown=node:node *.sh $MM_DIR/

ARG GIT_INFO
RUN <<EOF
set -e
chown node:node $MM_DIR
apk add --no-cache git nano tzdata tini coreutils
echo "#!/bin/sh" > /usr/local/bin/sudo
echo 'exec "$@"' >> /usr/local/bin/sudo
touch /etc/localtime /etc/timezone
chmod u+rwx,g+rwx,o+rwx /etc
chmod u+rw,g+rw,o+rw /etc/localtime /etc/timezone
chmod +x *.sh /usr/local/bin/sudo
git config --system --add safe.directory $MM_DIR
git config core.fileMode false
./build_info.sh "Runtime" "$GIT_INFO"
rm -f build_info.sh
EOF

USER node

ENV NODE_ENV=production \
    MM_OVERRIDE_DEFAULT_MODULES=true

EXPOSE 8080

ENTRYPOINT ["/sbin/tini", "--", "./entrypoint.sh"]