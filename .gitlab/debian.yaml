.runtimebuild:
  script:
    - !reference [.init, script]
    - |
      set -e
      echo "Building debian image ..."
      [[ "${FAT}" != "_fat" ]] && export SLIM="-slim"
      [[ "${FAT}" == "_debug" ]] && export NODE_ENV="test" || export NODE_ENV="production"
      export BUILDKIT_VARS="NODE_VERSION GIT_INFO CI_REGISTRY_IMAGE BUILDER_TAG DEBIAN_VERSION SLIM CI_PROJECT_ID FAT NODE_ENV"
      if [[ "${FAT}" == "_debug" ]]; then
        export TARGETPLATFORM="linux/amd64"
      else
        export TARGETPLATFORM="linux/amd64,linux/arm64,linux/arm/v7"
        if [[ "$NODE_VERSION" != "22" ]]; then
          echo "using node version 22 for arm build because no node version $NODE_VERSION available for this architecture."
        fi
      fi
      set | grep -E "NODE_VERSION=|CI_REGISTRY_IMAGE=|BUILDER_TAG=|FAT=|DEBIAN_VERSION="

build_debian_slim:
  stage: build
  image: ${CI_REGISTRY}/khassel/buildkit:rootless
  variables:
    CNTNR_FILE_NAME: "Dockerfile-debian"
    FAT: "_default"
  needs:
    - "bld_art: [amd64_default]"
    - "bld_art: [arm64_default]"
    - "bld_art: [arm_default]"
  extends:
    - .rule
  environment:
    name: "$CI_COMMIT_BRANCH/Build Debian slim"
  script:
    - !reference [.runtimebuild, script]
    - |
      if [[ "${CI_COMMIT_BRANCH}" == "master" ]]; then
        export PUSH_IMAGES="${CI_REGISTRY_IMAGE}:${CI_COMMIT_BRANCH},${DOCKER_USER}/magicmirror:latest,${DOCKER_USER}/magicmirror:${MAGICMIRROR_VERSION}"
      else
        export PUSH_IMAGES="${CI_REGISTRY_IMAGE}:${CI_COMMIT_BRANCH},${DOCKER_USER}/magicmirror:${CI_COMMIT_BRANCH}"
      fi
      build

build_debian_fat:
  stage: build
  image: ${CI_REGISTRY}/khassel/buildkit:rootless
  variables:
    CNTNR_FILE_NAME: "Dockerfile-debian"
    FAT: "_fat"
  needs:
    - "bld_art: [amd64_fat]"
    - "bld_art: [arm64_fat]"
    - "bld_art: [arm_fat]"
  extends:
    - .rule
  environment:
    name: "$CI_COMMIT_BRANCH/Build Debian fat"
  script:
    - !reference [.runtimebuild, script]
    - |
      if [[ "${CI_COMMIT_BRANCH}" == "master" ]]; then
        export PUSH_IMAGES="${DOCKER_USER}/magicmirror:fat,${DOCKER_USER}/magicmirror:${MAGICMIRROR_VERSION}_fat"
      else
        export PUSH_IMAGES="${DOCKER_USER}/magicmirror:${CI_COMMIT_BRANCH}_fat"
      fi
      build

.build_debug:
  stage: build
  image: ${CI_REGISTRY}/khassel/buildkit:rootless
  variables:
    CNTNR_FILE_NAME: "Dockerfile-debian"
    FAT: "_debug"
    PUSH_IMAGES: "${CI_REGISTRY_IMAGE}:${CI_COMMIT_BRANCH}_debug${NODE_VERSION}"
  needs:
    - "bld_art: [amd64_debug]"
  extends:
    - .rulenomaster
  environment:
    name: "$CI_COMMIT_BRANCH/Build Debug"
  script:
    - !reference [.runtimebuild, script]
    - build

build_debug22:
  variables:
    NODE_VERSION: "22"
  extends:
    - .build_debug

build_debug24:
  variables:
    NODE_VERSION: "24"
  extends:
    - .build_debug
