ARG CI_REGISTRY_IMAGE BUILDER_TAG FAT NODE_VERSION DEBIAN_VERSION SLIM
FROM ${CI_REGISTRY_IMAGE}:${BUILDER_TAG}_${TARGETARCH}${FAT}_artifacts AS builder
FROM node:${NODE_VERSION}-${DEBIAN_VERSION}${SLIM} AS build-amd64
FROM node:${NODE_VERSION}-${DEBIAN_VERSION}${SLIM} AS build-arm64
FROM node:22-bookworm${SLIM} AS build-arm
FROM build-${TARGETARCH}
LABEL maintainer="Karsten Hassel"

USER root

ENV MM_DIR=/opt/magic_mirror
WORKDIR $MM_DIR

# copy startscripts into container:
COPY --chmod=0777 --chown=node:node *.sh $MM_DIR/
COPY --from=builder --chmod=0777 --chown=node:node $MM_DIR $MM_DIR

SHELL ["/bin/bash", "-c"]

# procps, arp-scan needed for the module MMM-NetworkScanner
# modules which needs sudo must be run as root, use `user: root` in docker-compose.yaml
ARG GIT_INFO NODE_ENV DEBIAN_VERSION SLIM FAT CI_PROJECT_ID TARGETARCH
RUN <<EOF
set -e
chown node:node $MM_DIR
apt-get update
DEBIAN_FRONTEND=noninteractive apt-get -qy --no-install-recommends install git nano openssl ca-certificates wget tini gnupg
if [[ "${TARGETARCH}" == "amd64" && "${FAT}" == "_default" ]]; then
  echo "no installation of additional packages"
else
  _pck="${_pck} libgtk-3-0 libx11-xcb-dev libnss3-dev libxss1 libxtst6 libasound2 libdrm2 libgbm1 libxshmfence1 fonts-arphic-uming \
     procps arp-scan"
  if [[ "${TARGETARCH}" != "amd64" ]]; then
    # install pi stuff
    _pck="${_pck} libgl1-mesa-dri libglapi-mesa libsensors5 libdrm-radeon1 libelf1 libdrm-amdgpu1 \
      libdrm-nouveau2 x11-xserver-utils libgpiod-dev gpiod wlr-randr cec-utils libegl-mesa0 libegl1 libgl1 libgles2 \
      libglvnd0 libglx-mesa0 libglx0 libxcb-glx0 mesa-utils mesa-utils-bin"
    if [[ "${DEBIAN_VERSION}" == "bookworm" ]]; then
      _pck="${_pck} libraspberrypi-bin libllvm14 libegl1-mesa libgles2-mesa libwayland-egl1-mesa"
      wget https://archive.raspbian.org/raspbian.public.key -O - | gpg --dearmor -o /usr/share/keyrings/archive-raspian-keyring.gpg
      echo 'deb [signed-by=/usr/share/keyrings/archive-raspian-keyring.gpg] http://raspbian.raspberrypi.org/raspbian/ bookworm main contrib non-free rpi' | tee -a /etc/apt/sources.list
      wget -O - http://archive.raspberrypi.org/debian/raspberrypi.gpg.key | gpg --dearmor -o /usr/share/keyrings/archive-raspberrypi-keyring.gpg
      echo 'deb [signed-by=/usr/share/keyrings/archive-raspberrypi-keyring.gpg] http://archive.raspberrypi.org/debian/ bookworm main ui' | tee -a /etc/apt/sources.list.d/raspi.list
      apt-get update
      chmod u+rwx,g+rwx,o+rwx /etc
      chmod u+rw,g+rw,o+rw /etc/localtime /etc/timezone
    else
      # trixie
      _pck="${_pck} libllvm19 libegl1-mesa-dev libgles2-mesa-dev libwayland-egl1"
    fi
  fi
fi
if [[ "${NODE_ENV}" == "test" ]]; then
  _pck="${_pck} labwc libfaketime"
fi
DEBIAN_FRONTEND=noninteractive apt-get -qy --no-install-recommends install ${_pck}
DEBIAN_FRONTEND=noninteractive apt-get -qy remove gnupg
if [[ -z "${SLIM}" ]]; then
  # need newest version for arm32 so using pip
  DEBIAN_FRONTEND=noninteractive apt-get -qy install python3-dev python3-pip
  python3 -m pip install RPi.GPIO --no-cache-dir --break-system-packages
  DEBIAN_FRONTEND=noninteractive apt-get -qy remove python3-dev python3-pip
  DEBIAN_FRONTEND=noninteractive apt-get -qy autoremove
fi
apt-get clean
rm -rf /var/lib/apt/lists/*
echo "#!/bin/bash" > /usr/local/bin/sudo
echo 'exec "$@"' >> /usr/local/bin/sudo
chmod +x *.sh /usr/local/bin/sudo
git config --system --add safe.directory $MM_DIR
git config core.fileMode false
groupadd --gid 105 render
groupadd --gid 993 gpio
usermod -a -G gpio,video,render node
./build_info.sh "Runtime" "$GIT_INFO"
rm -f build_info.sh
EOF

USER node

ARG NODE_ENV
ENV ELECTRON_DISABLE_SANDBOX=1 \
    DBUS_SESSION_BUS_ADDRESS="unix:path=/var/run/dbus/system_bus_socket" \
    NODE_ENV=${NODE_ENV} \
    MM_OVERRIDE_DEFAULT_MODULES=true

EXPOSE 8080

ENTRYPOINT ["/usr/bin/tini", "--", "./entrypoint.sh"]
