.test_debug:
  stage: test
  variables:
    GIT_STRATEGY: none
    STARTENV: test
  script:
    - /opt/magic_mirror/entrypoint.sh
  extends:
    - .rulenomaster
  environment:
    name: "$CI_COMMIT_BRANCH/Test MagicMirror"

test_debug24:
  needs: ["build_debug24"]
  image:
    name: ${CI_REGISTRY_IMAGE}:${CI_COMMIT_BRANCH}_debug24
    entrypoint: [""]
  extends:
    - .test_debug

test_debug22:
  needs: ["build_debug22"]
  image:
    name: ${CI_REGISTRY_IMAGE}:${CI_COMMIT_BRANCH}_debug22
    entrypoint: [""]
  extends:
    - .test_debug

test_electron_rebuild:
  stage: test
  variables:
    GIT_STRATEGY: none
  image: nikolaik/python-nodejs:python3.13-nodejs${NODE_VERSION_DEVELOP}
  script:
    - |
      apt-get update
      apt-get install -y gpiod libgpiod2 libgpiod-dev build-essential libgtk-3-0 libx11-xcb-dev libnss3-dev libxss1 libxtst6 libasound2 libdrm2 libgbm1 libxshmfence1
      node -v
      python --version
      cd
      npm init -y
      npm install electron @electron/rebuild node-libgpiod onoff node-pty drivelist
      npx electron -v --no-sandbox
      echo "electron-rebuild version:"
      npx electron-rebuild --version
      echo "run electron-rebuild:"
      npx electron-rebuild
  rules:
    - if: $TASK == "electronrebuild"
  environment:
    name: "Test Electron rebuild"

snyk_amd64:
  stage: test
  image:
    name: ${CI_REGISTRY_IMAGE}:${CI_COMMIT_BRANCH}_debug24
    entrypoint: [""]
  script:
    - cd /opt/magic_mirror
    - npm install snyk npm-check-updates
    - npx ncu --deep
    - npx ncu --deep --target minor
    - npx snyk auth ${SNYK_TOKEN}
    - npx snyk test --all-projects
  rules:
    - if: $TASK == "snyk"
  environment:
    name: "$CI_COMMIT_BRANCH/Snyk Security Scan"

# see https://docs.gitlab.com/ee/user/application_security/container_scanning/
# see https://gitlab.com/gitlab-org/gitlab/-/blob/master/lib/gitlab/ci/templates/Security/Container-Scanning.gitlab-ci.yml
container_scanning:
  stage: test
  variables:
    CS_IMAGE : karsten13/magicmirror:develop
    CS_DOCKERFILE_PATH: build/Dockerfile-debian
    GIT_STRATEGY: fetch
  rules:
    - if: $TASK == "containerscan"
  environment:
    name: "$CI_COMMIT_BRANCH/Gitlab Security Scan"

triage:
  # Links:
  # https://about.gitlab.com/handbook/marketing/strategic-marketing/getting-started/105/
  # https://medium.com/analytics-vidhya/gitlab-triage-bot-ba8afca4440a
  # https://gitlab.com/gitlab-org/ruby/gems/gitlab-triage/-/blob/master/README.md
  stage: test
  image: ruby:latest
  script:
    - gem install gitlab-triage
    - gitlab-triage --token $TRIAGE_API_TOKEN --source projects --source-id $CI_PROJECT_PATH
  rules:
    - if: $TASK == "triage"
  environment:
    name: "$CI_COMMIT_BRANCH/Triage"
