# IMGKEY=architecture_{min|default|fat|debug}
# Variants:
# amd64_min: no opt, no dev
# amd64_default: no opt, no dev
# amd64_fat: incl. opt, no dev
# amd64_debug: incl. opt and dev
# arm_min: no opt, no dev (only used in alpine)
# arm_default: incl. opt, no dev
# arm_fat: incl. opt, no dev
# arm64_min: no opt, no dev (only used in alpine)
# arm64_fat: incl. opt, no dev
# arm64_default: incl. opt, no dev

check_artifacts:
  stage: build
  image:
    name: alpine/crane:latest
    entrypoint: [""]
  script:
    - |
      touch buildvars
      for arch in "arm64_min" "arm64_default" "arm64_fat" "arm_min" "arm_default" "arm_fat" "amd64_min" "amd64_default" "amd64_fat" "amd64_debug"; do
        img="${CI_REGISTRY_IMAGE}:${MAGICMIRROR_VERSION}_${arch}_artifacts"
        echo "checking $img ..."
        [ "$(crane config ${img} 2>/dev/null)" ] || echo "${arch}_" >> buildvars
      done
      cat buildvars
  rules:
    - if: $TASK == "runtime" && $CI_COMMIT_BRANCH == "master"
  artifacts:
    paths:
      - buildvars
  environment:
    name: "$CI_COMMIT_BRANCH/Check Artifacts"

bld_art:
  stage: build
  variables:
    CNTNR_FILE_NAME: "Dockerfile-artifacts"
  script:
    - !reference [.init, script]
    - |
      set -e
      if [ "${CI_COMMIT_BRANCH}" = "master" ]; then
        cat buildvars
        if [ "$(cat buildvars | grep ${IMGKEY}_)" != "${IMGKEY}_" ]; then
          echo "no builder image rebuild"
          exit 0
        fi
        echo "CI_COMMIT_BRANCH is master"
        export BuildRef="${MAGICMIRROR_VERSION}"
      else
        echo "CI_COMMIT_BRANCH is not master"
        export BuildRef="develop"
      fi
      export PUSH_IMAGES="${CI_REGISTRY_IMAGE}:${BUILDER_TAG}_${IMGKEY}_artifacts"
      set | grep -E "NODE_VERSION=|BuildRef=|GITREPO_URL="
      export BUILDKIT_VARS="NODE_VERSION GIT_INFO IMGKEY BuildRef GITREPO_URL BUILDKIT_IMG"
      build
  rules:
    - if: $TASK == "runtime" && $CI_COMMIT_BRANCH == "master"
      needs:
        - job: check_artifacts
          artifacts: true
    - if: $TASK == "runtime"
  parallel:
    matrix:
      - IMGKEY:
          [
            "arm64_min",
            "arm64_default",
            "arm64_fat",
            "arm_min",
            "arm_default",
            "arm_fat",
            "amd64_min",
            "amd64_default",
            "amd64_fat",
            "amd64_debug"
          ]
  environment:
    name: "$CI_COMMIT_BRANCH/Build Artifacts $IMGKEY"
