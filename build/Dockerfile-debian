ARG CI_REGISTRY_IMAGE BUILDER_TAG FAT NODE_VERSION DEBIAN_VERSION SLIM
FROM ${CI_REGISTRY_IMAGE}:${BUILDER_TAG}_${TARGETARCH}${FAT}_artifacts AS builder
FROM node:${NODE_VERSION}-${DEBIAN_VERSION}${SLIM}
LABEL maintainer="Karsten Hassel"

USER root

ENV MM_DIR=/opt/magic_mirror
WORKDIR $MM_DIR

# copy startscripts into container:
COPY --chmod=0777 --chown=node:node *.sh $MM_DIR/
COPY --from=builder --chmod=0777 --chown=node:node $MM_DIR $MM_DIR

SHELL ["/bin/bash", "-c"]

# procps, arp-scan needed for the module MMM-NetworkScanner
# modules which needs sudo must be run as root, use `user: root` in docker-compose.yaml
ARG GIT_INFO NODE_ENV DEBIAN_VERSION SLIM FAT CI_PROJECT_ID TARGETARCH
RUN <<EOF
set -e
chown node:node $MM_DIR
apt-get update
DEBIAN_FRONTEND=noninteractive apt-get -qy --no-install-recommends install git nano openssl ca-certificates wget tini gnupg
if [[ "${TARGETARCH}" == "amd64" && "${FAT}" == "_default" ]]; then \
  echo "no installation of additional packages"
else \
  _pck="${_pck} libgtk-3-0 libx11-xcb-dev libnss3-dev libxss1 libxtst6 libasound2 libdrm2 libgbm1 libxshmfence1 fonts-arphic-uming procps arp-scan"
  if [[ "${TARGETARCH}" != "amd64" ]]; then \
    # install pi stuff
    _pck="${_pck} libraspberrypi-bin libllvm14 libgl1-mesa-dri libglapi-mesa libsensors5 libdrm-radeon1 libelf1 libdrm-amdgpu1 libdrm-nouveau2 x11-xserver-utils libgpiod-dev gpiod wlr-randr"
    wget https://archive.raspbian.org/raspbian.public.key -O - | apt-key add -
    echo 'deb http://raspbian.raspberrypi.org/raspbian/ '${DEBIAN_VERSION}' main contrib non-free rpi' | tee -a /etc/apt/sources.list
    wget -O - http://archive.raspberrypi.org/debian/raspberrypi.gpg.key | apt-key add -
    echo 'deb http://archive.raspberrypi.org/debian/ '${DEBIAN_VERSION}' main ui' | tee -a /etc/apt/sources.list.d/raspi.list
    apt-get update
  fi
fi
if [[ "${NODE_ENV}" == "test" ]]; then \
  wget https://archive.raspbian.org/raspbian.public.key -O - | apt-key add -
  echo 'deb http://deb.debian.org/debian/ trixie main contrib non-free non-free-firmware' | tee -a /etc/apt/sources.list
  apt-get update
  _pck="${_pck} labwc"
  wget -P /usr/local/lib "https://gitlab.com/api/v4/projects/${CI_PROJECT_ID}/packages/generic/libfaketime/0.0.1/libfaketime.so.1"
fi
DEBIAN_FRONTEND=noninteractive apt-get -qy --no-install-recommends install ${_pck}
DEBIAN_FRONTEND=noninteractive apt-get -qy remove gnupg
if [[ -z "${SLIM}" ]]; then \
  # need newest version for arm32 so using pip
  DEBIAN_FRONTEND=noninteractive apt-get -qy install python3-dev python3-pip
  python3 -m pip install RPi.GPIO --no-cache-dir --break-system-packages
  DEBIAN_FRONTEND=noninteractive apt-get -qy remove python3-dev python3-pip
  DEBIAN_FRONTEND=noninteractive apt-get -qy autoremove
fi
apt-get clean
rm -rf /var/lib/apt/lists/*
usermod -a -G video node
echo "#!/bin/bash" > /usr/local/bin/sudo
echo 'exec "$@"' >> /usr/local/bin/sudo
chmod +x *.sh /usr/local/bin/sudo
chmod u+rwx,g+rwx,o+rwx /etc
chmod u+rw,g+rw,o+rw /etc/localtime /etc/timezone
git config --system --add safe.directory $MM_DIR
git config core.fileMode false
groupadd --gid 993 gpio
usermod -a -G gpio node
./build_info.sh "Runtime" "$GIT_INFO"
rm -f build_info.sh
EOF

USER node

ARG NODE_ENV
ENV ELECTRON_DISABLE_SANDBOX=1 \
    DBUS_SESSION_BUS_ADDRESS="unix:path=/var/run/dbus/system_bus_socket" \
    NODE_ENV=${NODE_ENV} \
    MM_OVERRIDE_DEFAULT_MODULES=true

EXPOSE 8080

ENTRYPOINT ["/usr/bin/tini", "--", "./entrypoint.sh"]
