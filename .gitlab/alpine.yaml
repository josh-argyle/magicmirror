build_alpine:
  stage: build
  needs:
    - "bld_art: [amd64_min]"
    - "bld_art: [arm64_min]"
    - "bld_art: [arm_min]"
  variables:
    DOCKERFILE_NAME: "Dockerfile-alpine"
    REGISTRY: "docker"
  script:
    - !reference [.init, script]
    - |
      set -e
      echo "Building alpine image ..."
      BUILDKIT_VARS="NODE_VERSION GIT_INFO CI_REGISTRY_IMAGE BUILDER_TAG"
      if [[ "$NODE_VERSION" != "22" ]]; then
        echo "skipping arm build because no node version $NODE_VERSION available for this architecture."
        export TARGETPLATFORM="linux/amd64,linux/arm64"
      else
        export TARGETPLATFORM="linux/amd64,linux/arm64,linux/arm/v7"
      fi
      if [[ "${CI_COMMIT_BRANCH}" == "master" ]]; then
        export PUSH_IMAGES="${DOCKER_USER}/magicmirror:${CI_COMMIT_BRANCH}_alpine,${DOCKER_USER}/magicmirror:alpine,${DOCKER_USER}/magicmirror:${MAGICMIRROR_VERSION}_alpine"
      else
        export PUSH_IMAGES="${DOCKER_USER}/magicmirror:${CI_COMMIT_BRANCH}_alpine"
      fi
      set | grep -E "NODE_VERSION=|CI_REGISTRY_IMAGE=|BUILDER_TAG="
    - !reference [.docker_buildkit, script]
  extends:
    - .docker_buildkit
    - .rule
  environment:
    name: "$CI_COMMIT_BRANCH/Build Alpine"

test_alpine:
  stage: test
  needs:
    - build_alpine
  variables:
    GIT_STRATEGY: none
  image:
    name: ${DOCKER_USER}/magicmirror:${CI_COMMIT_BRANCH}_alpine
    entrypoint: [""]
  script:
    - |
      set -e
      cd /opt/magic_mirror
      git log -1 > /tmp/image.txt
      if [ "${CI_COMMIT_BRANCH}" = "master" ]; then
        echo "CI_COMMIT_BRANCH is master"
        BuildRef="${MAGICMIRROR_VERSION}"
      else
        echo "CI_COMMIT_BRANCH is not master"
        BuildRef="develop"
      fi
      cd /tmp
      git clone --depth 1 -b "${BuildRef}" --single-branch "${GITREPO_URL}" mm
      cd mm
      git log -1 > /tmp/clone.txt
      cat /tmp/image.txt
      echo "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"
      cat /tmp/clone.txt
      echo "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"
      diff /tmp/image.txt /tmp/clone.txt
      echo "no diffs detected."
  extends:
    - .rule
  environment:
    name: "$CI_COMMIT_BRANCH/Test Alpine"
